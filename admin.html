<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>抽獎紀錄後台</title>
<style>
  body { background:#0f172a;color:#f8fafc;font-family:"Microsoft JhengHei",sans-serif;text-align:center;padding:30px;margin:0;}
  h1 { color:#facc15;margin-bottom:10px; }
  input { padding:8px;border-radius:6px;border:none;font-size:16px;width:200px;margin:10px; }
  button { padding:8px 16px;border:none;border-radius:6px;font-size:16px;cursor:pointer;font-weight:bold;margin:5px;}
  #export-btn{background:#38bdf8;color:#0f172a;}
  #clear-history{background:#ef4444;color:white;}
  #clear-history:hover{background:#dc2626;}
  #table-wrapper{max-height:70vh;overflow-y:auto;width:95%;margin:auto;}
  table{border-collapse:collapse;margin:20px auto;width:95%;max-width:800px;background:#1e293b;border-radius:8px;overflow:hidden;}
  th,td{border:1px solid #334155;padding:8px;}
  th{background:#334155;color:#facc15;position:sticky;top:0;z-index:2;}
  tr:nth-child(even){background:#0f172a;}
  td.clickable{color:#38bdf8;cursor:pointer;text-decoration:underline;}
  #back-btn{background:#64748b;color:white;margin-top:20px;}
</style>
</head>
<body>
  <h1>📜 抽獎紀錄後台</h1>
  <input type="text" id="search" placeholder="搜尋班級或座號...">
  <button id="clear">顯示全部</button>
  <button id="export-btn">匯出 CSV</button>
  <button id="clear-history">🧹 清除全部紀錄</button>

  <div id="table-wrapper">
    <table id="history-table">
      <thead>
        <tr><th>班級</th><th>座號</th><th>獎品</th><th>時間</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="back-btn" onclick="window.close()">關閉視窗</button>

<script>
let history = [];

fetch("fetch("https://script.google.com/macros/s/AKfycbwNIdWWCgKdP8Ee8WfbyheH_TwTFDuGRtAl7W9zza9nlKhKs3DVW3KvB-1rJ8N-yaIFOA/exec")
")
  .then(res => res.json())
  .then(data => {
    history = data.sort((a,b)=>new Date(b.time)-new Date(a.time));
    renderTable(history);
  })
  .catch(err=>{
    alert("⚠️ 雲端讀取失敗，改用本機資料。");
    history = JSON.parse(localStorage.getItem("drawHistory")||"[]");
    renderTable(history);
  });

const tbody=document.querySelector("#history-table tbody");
const searchInput=document.getElementById("search");

function renderTable(data){
  tbody.innerHTML=data.map(h=>`
    <tr>
      <td class="clickable" onclick="showStudent('${h.className}','${h.seat}')">${h.className}</td>
      <td class="clickable" onclick="showStudent('${h.className}','${h.seat}')">${h.seat}</td>
      <td>${h.prize}</td><td>${h.time}</td>
    </tr>`).join("")||"<tr><td colspan='4'>目前沒有抽獎紀錄</td></tr>";
}

searchInput.addEventListener("input",()=>{
  const keyword=searchInput.value.trim();
  if(!keyword)renderTable(history);
  else{
    const filtered=history.filter(h=>h.className.includes(keyword)||h.seat.includes(keyword));
    renderTable(filtered);
  }
});
document.getElementById("clear").addEventListener("click",()=>{searchInput.value="";renderTable(history);});

function showStudent(className,seat){
  const filtered=history.filter(h=>h.className===className&&h.seat===seat);
  alert(`🎯 ${className}班${seat}號的紀錄：\n\n`+filtered.map(f=>`• ${f.prize}（${f.time}）`).join("\n"));
}

document.getElementById("export-btn").addEventListener("click",()=>{
  if(history.length===0){alert("沒有資料可匯出");return;}
  const csvRows=[["班級","座號","獎品","時間"],...history.map(h=>[h.className,h.seat,h.prize,h.time])];
  const csvContent=csvRows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="抽獎紀錄.csv";a.click();
});

// 🧹 清除所有紀錄（本機端）
document.getElementById("clear-history").addEventListener("click",()=>{
  if(confirm("⚠️ 確定要刪除所有本機紀錄嗎？雲端資料不會受影響！")){
    localStorage.removeItem("drawHistory");
    alert("✅ 已清除本機紀錄");
    location.reload();
  }
});
</script>
</body>
</html>
