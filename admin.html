<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æŠ½çç´€éŒ„å¾Œå°</title>
<style>
  body { background:#0f172a;color:#f8fafc;font-family:"Microsoft JhengHei",sans-serif;text-align:center;padding:30px;margin:0;}
  h1 { color:#facc15;margin-bottom:10px; }
  input { padding:8px;border-radius:6px;border:none;font-size:16px;width:200px;margin:10px; }
  button { padding:8px 16px;border:none;border-radius:6px;font-size:16px;cursor:pointer;font-weight:bold;margin:5px;}
  #export-btn{background:#38bdf8;color:#0f172a;}
  #clear-history{background:#ef4444;color:white;}
  #clear-history:hover{background:#dc2626;}
  #table-wrapper{max-height:70vh;overflow-y:auto;width:95%;margin:auto;}
  table{border-collapse:collapse;margin:20px auto;width:95%;max-width:800px;background:#1e293b;border-radius:8px;overflow:hidden;}
  th,td{border:1px solid #334155;padding:8px;}
  th{background:#334155;color:#facc15;position:sticky;top:0;z-index:2;}
  tr:nth-child(even){background:#0f172a;}
  td.clickable{color:#38bdf8;cursor:pointer;text-decoration:underline;}
  #back-btn{background:#64748b;color:white;margin-top:20px;}
</style>
</head>
<body>
  <h1>ğŸ“œ æŠ½çç´€éŒ„å¾Œå°</h1>
  <input type="text" id="search" placeholder="æœå°‹ç­ç´šæˆ–åº§è™Ÿ...">
  <button id="clear">é¡¯ç¤ºå…¨éƒ¨</button>
  <button id="export-btn">åŒ¯å‡º CSV</button>
  <button id="clear-history">ğŸ§¹ æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button>

  <div id="table-wrapper">
    <table id="history-table">
      <thead>
        <tr><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>çå“</th><th>æ™‚é–“</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="back-btn" onclick="window.close()">é—œé–‰è¦–çª—</button>

<script>
let history = [];

fetch("fetch("https://script.google.com/macros/s/AKfycbwNIdWWCgKdP8Ee8WfbyheH_TwTFDuGRtAl7W9zza9nlKhKs3DVW3KvB-1rJ8N-yaIFOA/exec")
")
  .then(res => res.json())
  .then(data => {
    history = data.sort((a,b)=>new Date(b.time)-new Date(a.time));
    renderTable(history);
  })
  .catch(err=>{
    alert("âš ï¸ é›²ç«¯è®€å–å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿè³‡æ–™ã€‚");
    history = JSON.parse(localStorage.getItem("drawHistory")||"[]");
    renderTable(history);
  });

const tbody=document.querySelector("#history-table tbody");
const searchInput=document.getElementById("search");

function renderTable(data){
  tbody.innerHTML=data.map(h=>`
    <tr>
      <td class="clickable" onclick="showStudent('${h.className}','${h.seat}')">${h.className}</td>
      <td class="clickable" onclick="showStudent('${h.className}','${h.seat}')">${h.seat}</td>
      <td>${h.prize}</td><td>${h.time}</td>
    </tr>`).join("")||"<tr><td colspan='4'>ç›®å‰æ²’æœ‰æŠ½çç´€éŒ„</td></tr>";
}

searchInput.addEventListener("input",()=>{
  const keyword=searchInput.value.trim();
  if(!keyword)renderTable(history);
  else{
    const filtered=history.filter(h=>h.className.includes(keyword)||h.seat.includes(keyword));
    renderTable(filtered);
  }
});
document.getElementById("clear").addEventListener("click",()=>{searchInput.value="";renderTable(history);});

function showStudent(className,seat){
  const filtered=history.filter(h=>h.className===className&&h.seat===seat);
  alert(`ğŸ¯ ${className}ç­${seat}è™Ÿçš„ç´€éŒ„ï¼š\n\n`+filtered.map(f=>`â€¢ ${f.prize}ï¼ˆ${f.time}ï¼‰`).join("\n"));
}

document.getElementById("export-btn").addEventListener("click",()=>{
  if(history.length===0){alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");return;}
  const csvRows=[["ç­ç´š","åº§è™Ÿ","çå“","æ™‚é–“"],...history.map(h=>[h.className,h.seat,h.prize,h.time])];
  const csvContent=csvRows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="æŠ½çç´€éŒ„.csv";a.click();
});

// ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼ˆæœ¬æ©Ÿç«¯ï¼‰
document.getElementById("clear-history").addEventListener("click",()=>{
  if(confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æœ¬æ©Ÿç´€éŒ„å—ï¼Ÿé›²ç«¯è³‡æ–™ä¸æœƒå—å½±éŸ¿ï¼")){
    localStorage.removeItem("drawHistory");
    alert("âœ… å·²æ¸…é™¤æœ¬æ©Ÿç´€éŒ„");
    location.reload();
  }
});
</script>
</body>
</html>
